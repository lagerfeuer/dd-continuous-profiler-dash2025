version: '3'
services:
  movies-api-mongo:
    image: mongo:5
    volumes:
    - ./mongo-seed:/docker-entrypoint-initdb.d
    ports:
    - 27017:27017

  datadog-agent:
    image: datadog/agent:latest
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_REMOTE_CONFIGURATION_ENABLED: 'true'
      DD_APM_ENABLED: 'true'
      DD_SITE: 'datadoghq.com'
      DD_APM_NON_LOCAL_TRAFFIC: 'true'
      DD_DOGSTATSD_NON_LOCAL_TRAFFIC: 'true'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
    expose:
      - "8126"

  leaky-api-java:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - 8082:8082
    environment:
      DD_AGENT_HOST: "datadog-agent"
      DD_RUNTIME_METRICS_ENABLED: "true"
      DD_TAGS: ${DD_TAGS}
      MONGO_URI: mongodb://movies-api-mongo:27017
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      - datadog-agent
      - movies-api-mongo
    restart: always
